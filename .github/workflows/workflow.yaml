name: Python Application

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Install Python 3.9.6 manually from source
    - name: Install Python 3.9.6 from source
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          build-essential \
          libssl-dev \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libreadline-dev \
          libsqlite3-dev \
          libgdbm-dev \
          libdb5.3-dev \
          libbz2-dev \
          libexpat1-dev \
          liblzma-dev \
          tk-dev \
          libffi-dev \
          uuid-dev
        wget https://www.python.org/ftp/python/3.9.6/Python-3.9.6.tgz
        tar -xf Python-3.9.6.tgz
        cd Python-3.9.6
        ./configure --enable-optimizations
        make -j$(nproc)
        sudo make altinstall

    - name: Set up Python 3.9.6
      run: |
        sudo update-alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.9 1
        sudo update-alternatives --set python3 /usr/local/bin/python3.9
        python3 --version

    - name: Install pip for Python 3.9.6
      run: |
        curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
        python3.9 get-pip.py
        python3.9 -m pip --version

    - name: Install dependencies
      run: python3.9 -m pip install -r requirements.txt

    # Set the IBM Quantum API key as an environment variable from GitHub Secrets
    - name: Set up API key from secrets
      run: echo "API key added to environment"
      env:
        IBM_QUANTUM_API_KEY: ${{ secrets.IBM_QUANTUM_API_KEY }}

    # Run your Python script with the environment variable available
    - name: Run your Python script
      run: |
        cd chsh_inequality  # Move into the chsh_inequality directory
        python3.9 run_chsh_inequality.py
      env:
        IBM_QUANTUM_API_KEY: ${{ secrets.IBM_QUANTUM_API_KEY }}
